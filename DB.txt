-- 1. USERS
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL, -- MD5
    language_pref VARCHAR(10) DEFAULT 'vi',
    avatar_url TEXT,
    phone VARCHAR(20),
    
    -- Th√¥ng tin c√° nh√¢n b·ªï sung
    address TEXT,                                   -- ƒê·ªãa ch·ªâ ng∆∞·ªùi d√πng
    date_of_birth DATE,                             -- Ng√†y sinh (d√πng DATE ƒë·ªÉ d·ªÖ t√≠nh tu·ªïi)
    
    status VARCHAR(20) CHECK (
        status IN ('active', 'inactive', 'banned')
    ) DEFAULT 'active',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


-- 1.2. ROLES
CREATE TABLE roles (
    role_id SERIAL PRIMARY KEY,
    role_name VARCHAR(50) UNIQUE NOT NULL,         -- e.g. 'admin', 'teacher'
    display_name VARCHAR(100),                     -- e.g. 'Qu·∫£n tr·ªã h·ªá th·ªëng'
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 1.3. USER_ROLES
CREATE TABLE user_roles (
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    role_id INT REFERENCES roles(role_id) ON DELETE CASCADE,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, role_id)
);

DELETE FROM class_group_members;
DELETE FROM registrations;

-- 1.4. PERMISSIONS
CREATE TABLE permissions (
    perm_id SERIAL PRIMARY KEY,
    perm_key VARCHAR(100) UNIQUE NOT NULL,         -- e.g. 'course.create'
    module VARCHAR(50),                            -- e.g. 'courses', 'users', 'exams'
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 1.5. ROLE_PERMISSIONS
CREATE TABLE role_permissions (
    role_id INT REFERENCES roles(role_id) ON DELETE CASCADE,
    perm_id INT REFERENCES permissions(perm_id) ON DELETE CASCADE,
    PRIMARY KEY (role_id, perm_id)
);


-- 2. COURSES
CREATE TABLE courses (
    course_id SERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    image_url TEXT,
    price NUMERIC(10,2) DEFAULT 0,
    level VARCHAR(50) CHECK (level IN ('beginner','intermediate','advanced')) DEFAULT 'beginner',
    duration_weeks INT DEFAULT 4,
    language VARCHAR(10) DEFAULT 'en',
    zalo_link TEXT NOT NULL,
    status VARCHAR(20) CHECK (status IN ('active','inactive','draft')) DEFAULT 'active',
    teacher_id INT REFERENCES users(user_id) ON DELETE SET NULL,  -- gi√°o vi√™n ph·ª• tr√°ch ch√≠nh
    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,  -- ng∆∞·ªùi t·∫°o kh√≥a (admin / academic manager)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2.1. COURSE_PREREQUISITES
CREATE TABLE course_prerequisites (
    id SERIAL PRIMARY KEY,
    course_id INT REFERENCES courses(course_id) ON DELETE CASCADE,      -- kh√≥a h·ªçc ch√≠nh
    prereq_course_id INT REFERENCES courses(course_id) ON DELETE CASCADE, -- kh√≥a h·ªçc y√™u c·∫ßu tr∆∞·ªõc
    UNIQUE (course_id, prereq_course_id)
);

-- 2.2. COURSE_TEACHERS
CREATE TABLE course_teachers (
    id SERIAL PRIMARY KEY,
    course_id INT REFERENCES courses(course_id) ON DELETE CASCADE,
    teacher_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    role_in_course VARCHAR(50) DEFAULT 'instructor', -- instructor / assistant / tutor
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (course_id, teacher_id)
);

-- 3. LESSONS
CREATE TABLE lessons (
    lesson_id SERIAL PRIMARY KEY,
    course_id INT REFERENCES courses(course_id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    order_index INT DEFAULT 0,

    -- üîπ Tr·∫°ng th√°i duy·ªát n·ªôi dung
    approval_status VARCHAR(20) CHECK (approval_status IN ('pending', 'approved', 'rejected')) DEFAULT 'pending',
    approved_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    approved_at TIMESTAMP,
    review_note TEXT,           -- Ghi ch√∫ ph·∫£n h·ªìi t·ª´ admin (n·∫øu b·ªã t·ª´ ch·ªëi)

    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3.1. LESSON MEDIA
CREATE TABLE lesson_media (
    media_id SERIAL PRIMARY KEY,
    lesson_id INT REFERENCES lessons(lesson_id) ON DELETE CASCADE,
    media_type VARCHAR(50) CHECK (media_type IN ('video','image','pdf')) NOT NULL,
    media_url TEXT NOT NULL,

    -- üîπ Th√¥ng tin ƒë·ªÉ t√≠nh ti·∫øn ƒë·ªô
    duration_seconds INT,       -- Th·ªùi l∆∞·ª£ng video/audio (n·∫øu c√≥)
    total_pages INT,            -- S·ªë trang n·∫øu l√† PDF

    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);s

-- 4. VOCABULARIES
CREATE TABLE vocabularies (
    vocab_id SERIAL PRIMARY KEY,
    lesson_id INT REFERENCES lessons(lesson_id) ON DELETE CASCADE,
    word VARCHAR(100) NOT NULL,
    phonetic VARCHAR(100),
    meaning TEXT,
    example TEXT,
    audio_url TEXT,
    image_url TEXT,  -- üì∑ H√¨nh minh h·ªça cho t·ª´
    part_of_speech VARCHAR(20),  -- danh t·ª´, ƒë·ªông t·ª´, t√≠nh t·ª´, v.v.
    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 1. DICTIONARY_HISTORY - L·ªãch s·ª≠ tra c·ª©u t·ª´ ƒëi·ªÉn
CREATE TABLE IF NOT EXISTS dictionary_history (
    history_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    word VARCHAR(100) NOT NULL,
    vocab_id INT REFERENCES vocabularies(vocab_id) ON DELETE SET NULL, -- N·∫øu t·ª´ c√≥ trong vocabularies
    searched_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index ƒë·ªÉ t√¨m ki·∫øm nhanh
CREATE INDEX IF NOT EXISTS idx_dictionary_history_user_id ON dictionary_history(user_id);
CREATE INDEX IF NOT EXISTS idx_dictionary_history_searched_at ON dictionary_history(searched_at DESC);
CREATE INDEX IF NOT EXISTS idx_dictionary_history_word ON dictionary_history(word);

-- 2. DICTIONARY_FAVORITES - T·ª´ y√™u th√≠ch
CREATE TABLE IF NOT EXISTS dictionary_favorites (
    favorite_id SERIAL PRIMARY KEY,
    user_id INT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    vocab_id INT NOT NULL REFERENCES vocabularies(vocab_id) ON DELETE CASCADE,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, vocab_id)
);

-- Index ƒë·ªÉ t√¨m ki·∫øm nhanh
CREATE INDEX IF NOT EXISTS idx_dictionary_favorites_user_id ON dictionary_favorites(user_id);
CREATE INDEX IF NOT EXISTS idx_dictionary_favorites_added_at ON dictionary_favorites(added_at DESC);


-- 5. LISTENING EXERCISES (B√†i nghe - m·ªói audio 1 l·∫ßn)
CREATE TABLE listening_exercises (
    exercise_id SERIAL PRIMARY KEY,
    lesson_id INT REFERENCES lessons(lesson_id) ON DELETE CASCADE,
    title VARCHAR(200),
    audio_url TEXT NOT NULL,
    transcript TEXT,  -- L∆∞u n·ªôi dung script (t√πy ch·ªçn)
    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 5.1. LISTENING QUESTIONS (C√°c c√¢u h·ªèi thu·ªôc b√†i nghe)
CREATE TABLE listening_questions (
    question_id SERIAL PRIMARY KEY,
    exercise_id INT REFERENCES listening_exercises(exercise_id) ON DELETE CASCADE,
    question_type VARCHAR(20)
        CHECK (question_type IN ('multiple_choice', 'true_false', 'fill_blank'))
        DEFAULT 'multiple_choice',
    question TEXT NOT NULL,
    options JSONB NOT NULL DEFAULT '[]'::jsonb,
    correct_answer JSONB NOT NULL DEFAULT '[]'::jsonb,
    order_index INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 5.2. LISTENING_ANSWERS 
CREATE TABLE listening_attempt_sets (
    attempt_set_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    exercise_id INT REFERENCES listening_exercises(exercise_id) ON DELETE CASCADE,
    -- L·∫ßn h·ªçc (attempt) t∆∞∆°ng ·ª©ng
    reg_id INT REFERENCES registrations(reg_id),
    correct_count INT DEFAULT 0,
    total_questions INT DEFAULT 0,
    accuracy_percent NUMERIC(5,2) DEFAULT 0 CHECK (accuracy_percent BETWEEN 0 AND 100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 5.3. LISTENING_ANSWERS 
CREATE TABLE listening_answers (
    answer_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    question_id INT REFERENCES listening_questions(question_id) ON DELETE CASCADE,
    attempt_set_id INT REFERENCES listening_attempt_sets(attempt_set_id) ON DELETE CASCADE,
    user_answer JSONB,          -- Th√™m ƒë·ªÉ l∆∞u c√¢u tr·∫£ l·ªùi
    is_correct BOOLEAN,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


-- 7. QUIZZES
CREATE TABLE quizzes (
    quiz_id SERIAL PRIMARY KEY,
    lesson_id INT REFERENCES lessons(lesson_id) ON DELETE CASCADE,

    -- N·ªôi dung c√¢u h·ªèi
    question TEXT NOT NULL,
    question_type VARCHAR(30)
        CHECK (question_type IN ('multiple_choice', 'fill_blank', 'ordering'))
        DEFAULT 'multiple_choice',
    explanation TEXT,

    -- D·ªØ li·ªáu ƒë·ªông cho t·ª´ng lo·∫°i c√¢u h·ªèi
    options JSONB DEFAULT '[]'::jsonb,
    correct_answer JSONB DEFAULT '[]'::jsonb,

    -- Th·ª© t·ª± v√† meta
    order_index INT DEFAULT 0,
    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


-- 7.1. QUIZ_ATTEMPT_SETS (l∆∞u m·ªói l·∫ßn n·ªôp b√†i quiz)
CREATE TABLE quiz_attempt_sets (
    attempt_set_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    lesson_id INT REFERENCES lessons(lesson_id) ON DELETE CASCADE,
    -- L·∫ßn h·ªçc (attempt) t∆∞∆°ng ·ª©ng
    reg_id INT REFERENCES registrations(reg_id),
    average_score NUMERIC(5,2) DEFAULT 0,
    total_questions INT DEFAULT 0,
    correct_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


-- 7.2. QUIZ_ATTEMPTS
CREATE TABLE quiz_attempts (
    attempt_id SERIAL PRIMARY KEY,

    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    quiz_id INT REFERENCES quizzes(quiz_id) ON DELETE CASCADE,
    attempt_set_id INT REFERENCES quiz_attempt_sets(attempt_set_id) ON DELETE CASCADE,

    -- K·∫æT QU·∫¢ L·∫¶N L√ÄM
    is_correct BOOLEAN,                    -- TRUE n·∫øu ƒë√∫ng ho√†n to√†n (score = 100)
    user_answer JSONB,                     -- c√¢u tr·∫£ l·ªùi c·ªßa h·ªçc vi√™n (m·∫£ng)
    score_percent NUMERIC(5,2)
        CHECK (score_percent BETWEEN 0 AND 100),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


-- 8. WRITING EXERCISES
CREATE TABLE writing_exercises (
    exercise_id SERIAL PRIMARY KEY,
    lesson_id INT REFERENCES lessons(lesson_id) ON DELETE CASCADE,
    
    title VARCHAR(200),
    prompt TEXT NOT NULL,                             -- ƒê·ªÅ b√†i vi·∫øt
    sample_answer TEXT,                               -- B√†i m·∫´u (n·∫øu c√≥)
    word_limit INT CHECK (word_limit >= 0),           -- Gi·ªõi h·∫°n t·ª´
    order_index INT DEFAULT 0,
    
    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
); 



-- 8.1. WRITING SUBMISSIONS (B√†i n·ªôp c·ªßa h·ªçc vi√™n)
CREATE TABLE writing_submissions (
    submission_id SERIAL PRIMARY KEY,
    exercise_id INT REFERENCES writing_exercises(exercise_id) ON DELETE CASCADE,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    
    -- L·∫ßn h·ªçc (attempt) t∆∞∆°ng ·ª©ng
    reg_id INT REFERENCES registrations(reg_id),
    
    content TEXT NOT NULL,                            -- B√†i vi·∫øt c·ªßa h·ªçc vi√™n
    file_url TEXT,                                    -- File ƒë√≠nh k√®m (t√πy ch·ªçn)
    word_count INT CHECK (word_count >= 0),           -- S·ªë t·ª´ (c√≥ th·ªÉ t·ª± ƒë·ªông ƒë·∫øm)
    
    grade NUMERIC(5,2) CHECK (grade BETWEEN 0 AND 100), -- ƒêi·ªÉm ch·∫•m (hi·ªÉn th·ªã ri√™ng)
    feedback TEXT,                                    -- Nh·∫≠n x√©t c·ªßa gi√°o vi√™n
    graded_by INT REFERENCES users(user_id) ON DELETE SET NULL, -- Ng∆∞·ªùi ch·∫•m
    
    status VARCHAR(20) CHECK (
        status IN ('submitted', 'reviewed', 'resubmitted')
    ) DEFAULT 'submitted',
    
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    graded_at TIMESTAMP
);

-- 9. REGISTRATIONS
-- =========================================================
-- 1Ô∏è‚É£ REGISTRATIONS ‚Äì h·ªó tr·ª£ h·ªçc l·∫°i kh√≥a (multiple attempts)
-- =========================================================
CREATE TABLE registrations (
    reg_id SERIAL PRIMARY KEY,
    user_id INT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    course_id INT NOT NULL REFERENCES courses(course_id) ON DELETE CASCADE,
    payment_id INT REFERENCES payments(payment_id) ON DELETE SET NULL,

    -- L·∫ßn h·ªçc th·ª© m·∫•y c·ªßa h·ªçc vi√™n v·ªõi kh√≥a n√†y
    attempt_no INT NOT NULL DEFAULT 1,

    registration_status VARCHAR(20) CHECK (
        registration_status IN ('pending', 'paid', 'active', 'cancelled', 'completed')
    ) DEFAULT 'pending',

    registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    activated_at TIMESTAMP,
    completed_at TIMESTAMP,

    -- M·ªôt h·ªçc vi√™n c√≥ th·ªÉ h·ªçc l·∫°i 1 kh√≥a nhi·ªÅu l·∫ßn, nh∆∞ng attempt_no ph·∫£i kh√°c nhau
    UNIQUE (user_id, course_id, attempt_no)
);

-- 9.1. STUDY_SHIFTS
CREATE TABLE study_shifts (
    shift_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,      -- V√≠ d·ª•: 'Ca t·ªëi 2-4-6', 'Ca s√°ng 2-4-6'
    days_of_week VARCHAR(20) NOT NULL, 
    -- V√≠ d·ª•: '2,4,6' ho·∫∑c '3,5,7' (c√≥ th·ªÉ sau n√†y ƒë·ªïi sang JSONB n·∫øu mu·ªën)

    start_time TIME NOT NULL,        -- Gi·ªù b·∫Øt ƒë·∫ßu trong ng√†y, v√≠ d·ª•: '19:00'
    end_time   TIME NOT NULL,        -- Gi·ªù k·∫øt th√∫c, v√≠ d·ª•: '20:30'

    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 9.2. CLASS_GROUP_MEMBERS
-- =========================================================
-- 2Ô∏è‚É£ CLASS_GROUP_MEMBERS ‚Äì th√™m reg_id ƒë·ªÉ bi·∫øt thu·ªôc attempt n√†o
-- =========================================================
CREATE TABLE class_group_members (
    member_id SERIAL PRIMARY KEY,
    class_group_id INT NOT NULL REFERENCES class_groups(class_group_id) ON DELETE CASCADE,
    user_id INT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,

    -- ƒêƒÉng k√Ω (attempt) t∆∞∆°ng ·ª©ng c·ªßa h·ªçc vi√™n v·ªõi course_id c·ªßa class_group
    reg_id INT NOT NULL REFERENCES registrations(reg_id),

    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) CHECK (
        status IN ('enrolled', 'dropped', 'completed')
    ) DEFAULT 'enrolled',

    UNIQUE (class_group_id, user_id)
);

-- =========================================================
-- 3Ô∏è‚É£ CLASS_GROUP_TRANSFERS ‚Äì log l·ªãch s·ª≠ chuy·ªÉn l·ªõp
-- =========================================================
CREATE TABLE class_group_transfers (
    transfer_id SERIAL PRIMARY KEY,

    user_id INT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,

    from_class_group_id INT NOT NULL REFERENCES class_groups(class_group_id) ON DELETE CASCADE,
    to_class_group_id   INT NOT NULL REFERENCES class_groups(class_group_id) ON DELETE CASCADE,

    from_member_id INT REFERENCES class_group_members(member_id) ON DELETE SET NULL,
    to_member_id   INT REFERENCES class_group_members(member_id) ON DELETE SET NULL,

    -- Thu·ªôc c√πng m·ªôt registrations (c√πng attempt)
    reg_id INT NOT NULL REFERENCES registrations(reg_id),

    reason TEXT,
    note TEXT,

    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 9.3. CLASS_GROUPS
CREATE TABLE class_groups (
    class_group_id SERIAL PRIMARY KEY,
    course_id INT NOT NULL REFERENCES courses(course_id) ON DELETE CASCADE,
    shift_id INT NOT NULL REFERENCES study_shifts(shift_id) ON DELETE RESTRICT,

    name VARCHAR(200) NOT NULL,        -- V√≠ d·ª•: 'Giao ti·∫øp 1 - Kh√≥a 03/2026 - Ca t·ªëi 2-4-6'
    teacher_id INT REFERENCES users(user_id) ON DELETE SET NULL,  -- GV ch√≠nh

    start_date DATE NOT NULL,          -- Ng√†y khai gi·∫£ng c·ªßa l·ªõp
    end_date DATE,                     -- Ng√†y k·∫øt th√∫c d·ª± ki·∫øn (c√≥ th·ªÉ t√≠nh t·ª´ duration_weeks)

    max_students INT DEFAULT 20,       -- Sƒ© s·ªë t·ªëi ƒëa
	zalo_link TEXT,
    status VARCHAR(20) CHECK (
        status IN ('planning', 'open', 'ongoing', 'finished', 'cancelled')
    ) DEFAULT 'planning',

    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 11. CLASSES (qu·∫£n l√Ω c·∫£ online & offline)
CREATE TABLE classes (
    class_id SERIAL PRIMARY KEY,
	class_group_id INT REFERENCES class_groups(class_group_id) ON DELETE CASCADE,

	-- Gi√°o vi√™n ƒë·ª©ng l·ªõp trong BU·ªîI N√ÄY (c√≥ th·ªÉ kh√°c GV ch√≠nh trong class_groups)
    teacher_id INT REFERENCES users(user_id) ON DELETE SET NULL,
    
    title VARCHAR(200) NOT NULL,                         -- t√™n bu·ªïi h·ªçc ho·∫∑c k·ª≥ thi
    description TEXT,
    
    class_type VARCHAR(10) CHECK (
        class_type IN ('online', 'offline')
    ) NOT NULL DEFAULT 'online',                         -- online = h·ªçc th√™m, offline = thi
    
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP,

	attendance_start_time TIMESTAMP,
	attendance_end_time   TIMESTAMP,
    
    -- ONLINE (h·ªçc th√™m)
    meeting_link TEXT,                                   -- link l·ªõp h·ªçc online
    recording_url TEXT,                                  -- ghi h√¨nh bu·ªïi h·ªçc (n·∫øu c√≥)
    
    -- OFFLINE (thi c·ª≠)
    location TEXT,                                       -- ƒë·ªãa ƒëi·ªÉm thi
    exam_type VARCHAR(50) CHECK (
        exam_type IN ('midterm', 'final', 'makeup', 'other')
    ),                                                   -- lo·∫°i k·ª≥ thi (n·∫øu l√† offline)
    max_score NUMERIC(5,2) DEFAULT 100,                  -- ƒëi·ªÉm t·ªëi ƒëa cho k·ª≥ thi
    
    status VARCHAR(20) CHECK (
        status IN ('scheduled', 'live', 'completed', 'cancelled')
    ) DEFAULT 'scheduled',
    
    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ‚úÖ R√ÄNG BU·ªòC LOGIC: ƒë·∫£m b·∫£o l·ªõp online kh√¥ng c√≥ d·ªØ li·ªáu thi c·ª≠
    CONSTRAINT chk_class_type_validity CHECK (
        (class_type = 'online' AND exam_type IS NULL AND location IS NULL)
        OR (class_type = 'offline')
    )
);



-- 11.1. CLASS PARTICIPANTS
CREATE TABLE class_participants (
    participant_id SERIAL PRIMARY KEY,
    class_id INT NOT NULL REFERENCES classes(class_id) ON DELETE CASCADE,
    user_id INT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    
    attendance_status VARCHAR(20) CHECK (
        attendance_status IN ('joined', 'left', 'absent', 'late', 'present')
    ) DEFAULT 'joined',
    
    feedback TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (class_id, user_id)
);

-- 11.3. EXAM SCORES (l∆∞u ƒëi·ªÉm chi ti·∫øt t·ª´ng k·ªπ nƒÉng)
CREATE TABLE exam_scores (
    score_id SERIAL PRIMARY KEY,
    class_id INT REFERENCES classes(class_id) ON DELETE CASCADE,   -- li√™n k·∫øt v·ªõi l·ªõp thi (offline)
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,       -- h·ªçc vi√™n
    
    listening_score NUMERIC(5,2) DEFAULT 0,                        -- ƒêi·ªÉm nghe
    speaking_score NUMERIC(5,2) DEFAULT 0,                         -- ƒêi·ªÉm n√≥i
    reading_score NUMERIC(5,2) DEFAULT 0,                          -- ƒêi·ªÉm ƒë·ªçc
    writing_score NUMERIC(5,2) DEFAULT 0,                          -- ƒêi·ªÉm vi·∫øt

    total_score NUMERIC(6,2) DEFAULT 0,                            -- T·ªïng ƒëi·ªÉm (do backend t√≠nh v√† l∆∞u)
    
    feedback TEXT,                                                 -- Nh·∫≠n x√©t gi√°o vi√™n (n·∫øu c√≥)
    graded_by INT REFERENCES users(user_id) ON DELETE SET NULL,    -- Ng∆∞·ªùi ch·∫•m
    graded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE (class_id, user_id)                                     -- M·ªói h·ªçc vi√™n ch·ªâ c√≥ 1 b·∫£n ghi ƒëi·ªÉm / k·ª≥ thi
);

-- 10. PROGRESS
-- =========================================================
-- 4Ô∏è‚É£ PROGRESS ‚Äì th√™m reg_id ƒë·ªÉ ti·∫øn ƒë·ªô g·∫Øn v·ªõi t·ª´ng l·∫ßn h·ªçc
-- =========================================================
CREATE TABLE progress (
    progress_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    lesson_id INT REFERENCES lessons(lesson_id) ON DELETE CASCADE,

    -- L·∫ßn ƒëƒÉng k√Ω h·ªçc kh√≥a t∆∞∆°ng ·ª©ng
    reg_id INT NOT NULL REFERENCES registrations(reg_id),

    progress_percent NUMERIC(5,2) DEFAULT 0 CHECK (progress_percent BETWEEN 0 AND 100),
    status VARCHAR(20) CHECK (
        status IN ('not_started', 'in_progress', 'completed')
    ) DEFAULT 'not_started',

    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


-- 10.1 PROGRESS_PROGRESS-DETAILS
-- =========================================================
-- 5Ô∏è‚É£ LESSON_PROGRESS_DETAILS ‚Äì th√™m reg_id, unique theo attempt
-- =========================================================
CREATE TABLE lesson_progress_details (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    lesson_id INT REFERENCES lessons(lesson_id) ON DELETE CASCADE,

    -- L·∫ßn h·ªçc (attempt) t∆∞∆°ng ·ª©ng
    reg_id INT NOT NULL REFERENCES registrations(reg_id),

    content_type VARCHAR(30) CHECK (
        content_type IN ('vocabulary', 'listening', 'quiz', 'video', 'pdf', 'writing')
    ),
    content_id INT,

    progress_percent NUMERIC(5,2) DEFAULT 0 CHECK (progress_percent BETWEEN 0 AND 100),

    status VARCHAR(20) CHECK (
        status IN ('not_started', 'in_progress', 'completed')
    ) DEFAULT 'not_started',

    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- M·ªói n·ªôi dung trong m·ªói b√†i h·ªçc, m·ªói l·∫ßn h·ªçc ch·ªâ c√≥ 1 record
    UNIQUE (user_id, lesson_id, content_type, content_id, reg_id)
);

-- 1) Th√™m UNIQUE cho lesson_progress_details
ALTER TABLE lesson_progress_details
  ADD CONSTRAINT uq_lesson_progress_details_user_lesson_content_reg
  UNIQUE (user_id, lesson_id, content_type, content_id, reg_id);

 -- 2) Th√™m UNIQUE cho progress (v√¨ backend d√πng ON CONFLICT (user_id, lesson_id, reg_id))
ALTER TABLE progress
  ADD CONSTRAINT uq_progress_user_lesson_reg
  UNIQUE (user_id, lesson_id, reg_id);



-- 12. CERTIFICATES
CREATE TABLE certificates (
    cert_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    course_id INT REFERENCES courses(course_id) ON DELETE CASCADE,
    issue_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    cert_url TEXT,
    created_by INT REFERENCES users(user_id) ON DELETE SET NULL
);

-- 13. COURSE REVIEWS
CREATE TABLE course_reviews (
    review_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    course_id INT REFERENCES courses(course_id) ON DELETE CASCADE,
    rating INT CHECK (rating BETWEEN 1 AND 5),
    comment TEXT,
    is_visible BOOLEAN DEFAULT TRUE,               -- TRUE = hi·ªÉn th·ªã, FALSE = b·ªã ·∫©n
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 14. CHAT
CREATE TABLE chats (
    chat_id SERIAL PRIMARY KEY, 
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,  -- H·ªçc vi√™n li√™n quan ƒë·∫øn cu·ªôc tr√≤ chuy·ªán
    sender VARCHAR(20) CHECK (sender IN ('student','teacher','ai')) NOT NULL,
    message TEXT NOT NULL,
    read_by_student BOOLEAN DEFAULT FALSE,                    -- H·ªçc vi√™n ƒë√£ ƒë·ªçc tin n√†y ch∆∞a
    read_by_teacher BOOLEAN DEFAULT FALSE,                    -- Gi√°o vi√™n/nh√¢n vi√™n ƒë√£ ƒë·ªçc tin n√†y ch∆∞a
    read_at TIMESTAMP,                                        -- Th·ªùi ƒëi·ªÉm tin nh·∫Øn ƒë∆∞·ª£c ƒë·ªçc
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 15. NOTIFICATIONS
CREATE TABLE notifications (
    notification_id SERIAL PRIMARY KEY,
    sender_id INT REFERENCES users(user_id) ON DELETE SET NULL,        -- Ng∆∞·ªùi t·∫°o th√¥ng b√°o
    title VARCHAR(255) NOT NULL,                                       -- Ti√™u ƒë·ªÅ th√¥ng b√°o
    message TEXT NOT NULL,                                              -- N·ªôi dung
    course_id INT REFERENCES courses(course_id) ON DELETE SET NULL,     -- N·∫øu th√¥ng b√°o thu·ªôc kh√≥a h·ªçc
    class_group_id INT REFERENCES class_groups(class_group_id) ON DELETE SET NULL,  -- ‚úÖ M·ªöI: ID c·ªßa l·ªõp h·ªçc
    target_audience VARCHAR(50) DEFAULT 'user',                         -- 'all', 'course', 'class_group', 'user'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Th√™m comment ƒë·ªÉ gi·∫£i th√≠ch
COMMENT ON TABLE notifications IS 'B·∫£ng l∆∞u th√¥ng b√°o h·ªá th·ªëng';
COMMENT ON COLUMN notifications.sender_id IS 'ID ng∆∞·ªùi t·∫°o th√¥ng b√°o';
COMMENT ON COLUMN notifications.course_id IS 'ID kh√≥a h·ªçc (n·∫øu th√¥ng b√°o thu·ªôc kh√≥a h·ªçc)';
COMMENT ON COLUMN notifications.class_group_id IS 'ID l·ªõp h·ªçc (n·∫øu g·ª≠i cho m·ªôt l·ªõp c·ª• th·ªÉ, NULL n·∫øu g·ª≠i cho c·∫£ kh√≥a h·ªçc)';
COMMENT ON COLUMN notifications.target_audience IS 'ƒê·ªëi t∆∞·ª£ng nh·∫≠n: all (t·∫•t c·∫£), course (kh√≥a h·ªçc), class_group (l·ªõp), user (ng∆∞·ªùi d√πng c·ª• th·ªÉ)';

-- T·∫°o index ƒë·ªÉ tƒÉng hi·ªáu su·∫•t query
CREATE INDEX idx_notifications_sender_id ON notifications(sender_id);
CREATE INDEX idx_notifications_course_id ON notifications(course_id);
CREATE INDEX idx_notifications_class_group_id ON notifications(class_group_id);  -- ‚úÖ M·ªöI
CREATE INDEX idx_notifications_target_audience ON notifications(target_audience);
CREATE INDEX idx_notifications_created_at ON notifications(created_at);


-- 16. NOTIFICATION_RECIPIENTS
CREATE TABLE notification_recipients (
    recipient_id SERIAL PRIMARY KEY,
    notification_id INT REFERENCES notifications(notification_id) ON DELETE CASCADE,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    is_read BOOLEAN DEFAULT FALSE,              -- ƒê√£ ƒë·ªçc hay ch∆∞a
    read_at TIMESTAMP,                          -- Th·ªùi ƒëi·ªÉm ƒë·ªçc
    delivered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- Khi g·ª≠i th√¥ng b√°o
);

-- Th√™m comment
COMMENT ON TABLE notification_recipients IS 'B·∫£ng l∆∞u danh s√°ch ng∆∞·ªùi nh·∫≠n th√¥ng b√°o';
COMMENT ON COLUMN notification_recipients.is_read IS 'ƒê√£ ƒë·ªçc hay ch∆∞a';
COMMENT ON COLUMN notification_recipients.read_at IS 'Th·ªùi ƒëi·ªÉm ƒë·ªçc th√¥ng b√°o';
COMMENT ON COLUMN notification_recipients.delivered_at IS 'Th·ªùi ƒëi·ªÉm g·ª≠i th√¥ng b√°o';

-- T·∫°o index ƒë·ªÉ tƒÉng hi·ªáu su·∫•t query
CREATE INDEX idx_notification_recipients_notification_id ON notification_recipients(notification_id);
CREATE INDEX idx_notification_recipients_user_id ON notification_recipients(user_id);
CREATE INDEX idx_notification_recipients_is_read ON notification_recipients(is_read);
CREATE INDEX idx_notification_recipients_delivered_at ON notification_recipients(delivered_at);


CREATE TABLE IF NOT EXISTS push_tokens (
  id SERIAL PRIMARY KEY,
  user_id INT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  device_token TEXT NOT NULL,
  platform VARCHAR(20) NOT NULL CHECK (platform IN ('android','ios')),
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Helpful indexes for lookups
CREATE INDEX IF NOT EXISTS idx_push_tokens_user_id ON push_tokens(user_id);
CREATE INDEX IF NOT EXISTS idx_push_tokens_device_token ON push_tokens(device_token);


-- 16. MINIGAMES
CREATE TABLE minigames (
    game_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 17. LEADERBOARD
CREATE TABLE leaderboard (
    score_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    game_id INT REFERENCES minigames(game_id) ON DELETE CASCADE,
    score INT DEFAULT 0,
    achieved_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 18. SYSTEM SETTINGS
CREATE TABLE system_settings (
    setting_id SERIAL PRIMARY KEY,
    key VARCHAR(100) UNIQUE NOT NULL,
    value TEXT,
    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE payments
  ADD COLUMN IF NOT EXISTS class_group_id INT REFERENCES class_groups(class_group_id);

DELETE FROM payments;
DELETE FROM class_group_members;
DELETE FROM registrations;

-- 19. PAYMENTS
CREATE TABLE payments (
    payment_id SERIAL PRIMARY KEY,                                       -- M√£ giao d·ªãch n·ªôi b·ªô
    user_id INT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,    -- Ng∆∞·ªùi thanh to√°n (h·ªçc vi√™n)
    course_id INT REFERENCES courses(course_id) ON DELETE SET NULL,      -- Kh√≥a h·ªçc li√™n quan (c√≥ th·ªÉ NULL)
    
    amount NUMERIC(12,2) NOT NULL CHECK (amount >= 0),                   -- S·ªë ti·ªÅn thanh to√°n
    currency VARCHAR(10) DEFAULT 'VND',                                  -- ƒê∆°n v·ªã ti·ªÅn t·ªá

    payment_method VARCHAR(50) NOT NULL CHECK (                          -- Ph∆∞∆°ng th·ª©c thanh to√°n
        payment_method IN ('credit_card', 'momo', 'zalopay', 'bank_transfer', 'vnpay', 'cash')
    ),

    payment_status VARCHAR(20) DEFAULT 'pending' CHECK (                 -- Tr·∫°ng th√°i thanh to√°n
        payment_status IN ('pending', 'processing', 'completed', 'failed', 'refunded')
    ),

    transaction_id VARCHAR(100) UNIQUE,                                  -- M√£ giao d·ªãch n·ªôi b·ªô ho·∫∑c t·ª´ c·ªïng
    gateway_transaction_code VARCHAR(100),                               -- M√£ tr·∫£ v·ªÅ t·ª´ c·ªïng (VD: VNPAY TransactionNo)
    order_code VARCHAR(100) UNIQUE,                                      -- M√£ ƒë∆°n h√†ng g·ª≠i sang c·ªïng thanh to√°n
    bank_code VARCHAR(50),                                               -- M√£ ng√¢n h√†ng
    card_type VARCHAR(50),                                               -- Lo·∫°i th·∫ª (ATM, VISA,‚Ä¶)
    payment_url TEXT,                                                    -- URL thanh to√°n (n·∫øu online)
    payment_note TEXT,                                                   -- Ghi ch√∫ n·ªôi b·ªô

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,                      -- Th·ªùi ƒëi·ªÉm t·∫°o
    paid_at TIMESTAMP,                                                   -- Khi thanh to√°n th√†nh c√¥ng
    refund_at TIMESTAMP,                                                 -- Khi ho√†n ti·ªÅn
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,                      -- C·∫≠p nh·∫≠t cu·ªëi

    created_by INT REFERENCES users(user_id) ON DELETE SET NULL          -- Nh√¢n vi√™n/sales t·∫°o giao d·ªãch
);

-- 20. POSTS
CREATE TABLE posts (
    post_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    media_url TEXT,  -- h√¨nh ·∫£nh ho·∫∑c video ƒë√≠nh k√®m
    media_type VARCHAR(20) CHECK (media_type IN ('image', 'video')),
    category VARCHAR(50),  -- v√≠ d·ª•: 'announcement', 'discussion', 'question'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) CHECK (status IN ('active', 'hidden', 'deleted')) DEFAULT 'active'
);

-- 20.1 COMMENTS
CREATE TABLE comments (
    comment_id SERIAL PRIMARY KEY,
    post_id INT REFERENCES posts(post_id) ON DELETE CASCADE,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    parent_id INT REFERENCES comments(comment_id) ON DELETE CASCADE,  -- tr·∫£ l·ªùi b√¨nh lu·∫≠n kh√°c
    content TEXT NOT NULL,
    media_url TEXT,  -- h√¨nh ·∫£nh ho·∫∑c video ƒë√≠nh k√®m
    media_type VARCHAR(20) CHECK (media_type IN ('image', 'video')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) CHECK (status IN ('active', 'hidden', 'deleted')) DEFAULT 'active'
);

-- 20.2 POST_REACTIONS
CREATE TABLE post_reactions (
    reaction_id SERIAL PRIMARY KEY,
    post_id INT REFERENCES posts(post_id) ON DELETE CASCADE,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    reaction_type VARCHAR(10) CHECK (reaction_type IN ('like', 'dislike')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (post_id, user_id)
);


-- 20.3 COMMENT_REACTIONS
CREATE TABLE comment_reactions (
    reaction_id SERIAL PRIMARY KEY,
    comment_id INT REFERENCES comments(comment_id) ON DELETE CASCADE,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    reaction_type VARCHAR(10) CHECK (reaction_type IN ('like', 'dislike')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (comment_id, user_id)
);

-- 21. ACTIVITY LOGS
CREATE TABLE activity_logs (
    log_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    action VARCHAR(100),
    details JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 22. APP_UTILITIES
CREATE TABLE app_utilities (
    utility_id SERIAL PRIMARY KEY,
    key VARCHAR(100) UNIQUE NOT NULL,         -- m√£ ƒë·ªãnh danh, v√≠ d·ª•: 'dictionary', 'progress_tracker', 'ai_chat'
    name VARCHAR(100) NOT NULL,               -- t√™n hi·ªÉn th·ªã, v√≠ d·ª•: 'T·ª´ ƒëi·ªÉn', 'AI Chat', 'L·ªãch h·ªçc'
    description TEXT,                         -- m√¥ t·∫£ ng·∫Øn v·ªÅ ti·ªán √≠ch
    icon_url TEXT,                            -- ƒë∆∞·ªùng d·∫´n bi·ªÉu t∆∞·ª£ng hi·ªÉn th·ªã trong app
    route_path VARCHAR(200),                  -- ƒë∆∞·ªùng d·∫´n m√†n h√¨nh trong app (v√≠ d·ª•: '/dictionary')
    is_active BOOLEAN DEFAULT TRUE,           -- b·∫≠t / t·∫Øt hi·ªÉn th·ªã ti·ªán √≠ch trong app
    
    category VARCHAR(50),                     -- nh√≥m ti·ªán √≠ch: 'learning', 'communication', 'fun', 'system', ...
    display_order INT DEFAULT 0,              -- th·ª© t·ª± hi·ªÉn th·ªã
    
    created_by INT REFERENCES users(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 22.1. USER_UTILITIES
CREATE TABLE user_utilities (
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    utility_id INT REFERENCES app_utilities(utility_id) ON DELETE CASCADE,
    
    is_enabled BOOLEAN DEFAULT TRUE,               -- ng∆∞·ªùi d√πng c√≥ b·∫≠t ti·ªán √≠ch kh√¥ng
    pinned BOOLEAN DEFAULT FALSE,                  -- ng∆∞·ªùi d√πng c√≥ ghim ti·ªán √≠ch l√™n trang ch√≠nh kh√¥ng
    customized_label VARCHAR(100),                 -- t√™n t√πy ch·ªânh (n·∫øu cho ph√©p)
    
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, utility_id)
);

-- 23. SERVICE_FEEDBACK (G√≥p √Ω ƒë∆°n gi·∫£n)
CREATE TABLE service_feedback (
    feedback_id SERIAL PRIMARY KEY,

    user_id INT REFERENCES users(user_id) ON DELETE SET NULL,   -- Ng∆∞·ªùi g·ª≠i (n·∫øu c√≥)

    title VARCHAR(255) NOT NULL,        -- Ti√™u ƒë·ªÅ g√≥p √Ω
    content TEXT NOT NULL,              -- N·ªôi dung chi ti·∫øt

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);



INSERT INTO users (full_name, email, password_hash, language_pref, status, phone, address, date_of_birth)
VALUES
('Tr·∫ßn Minh Nghƒ©a', 'tranminhnghia4600@gmail.com', '$2b$10$uPQtaNXYb3kSkEKGL7GoRe.69Vf1jTnYHF4v7tql6Me1.XHJQ/OLC', 'vi', 'active', '0123456789', 'H√† N·ªôi', '1990-01-01'),
('Nghƒ©a 3008', 'nghia3008aaa@gmail.com', '$2b$10$uPQtaNXYb3kSkEKGL7GoRe.69Vf1jTnYHF4v7tql6Me1.XHJQ/OLC', 'vi', 'active', '0123456790', 'TP.HCM', '1985-05-15'),
('TM Nghƒ©a', 'tmnghia4600@gmail.com', '$2b$10$uPQtaNXYb3kSkEKGL7GoRe.69Vf1jTnYHF4v7tql6Me1.XHJQ/OLC', 'vi', 'active', '0123456791', 'ƒê√† N·∫µng', '1988-08-20'),
('Nghƒ©a Ph·∫°m', 'nghiapha1234@gmail.com', '$2b$10$uPQtaNXYb3kSkEKGL7GoRe.69Vf1jTnYHF4v7tql6Me1.XHJQ/OLC', 'vi', 'active', '0123456792', 'C·∫ßn Th∆°', '1992-12-10'),
('Nguy·ªÖn VƒÉn A', 'nguyenvana@gmail.com', '$2b$10$uPQtaNXYb3kSkEKGL7GoRe.69Vf1jTnYHF4v7tql6Me1.XHJQ/OLC', 'vi', 'active', '0123456793', 'H·∫£i Ph√≤ng', '1995-03-15'),
('Tr·∫ßn Th·ªã B', 'tranthib@gmail.com', '$2b$10$uPQtaNXYb3kSkEKGL7GoRe.69Vf1jTnYHF4v7tql6Me1.XHJQ/OLC', 'vi', 'active', '0123456794', 'Hu·∫ø', '1993-07-22');

-- ========================================================
-- 2Ô∏è‚É£ ROLES
-- ========================================================
INSERT INTO roles (role_name, display_name, description)
VALUES
('system_admin', 'Qu·∫£n tr·ªã vi√™n h·ªá th·ªëng', 'Qu·∫£n l√Ω to√†n b·ªô n·ªÅn t·∫£ng, ph√¢n quy·ªÅn, c·∫•u h√¨nh h·ªá th·ªëng, gi√°m s√°t ho·∫°t ƒë·ªông'),
('academic_manager', 'Tr∆∞·ªüng b·ªô ph·∫≠n h·ªçc v·ª•', 'Qu·∫£n l√Ω h·ªçc thu·∫≠t, kh√≥a h·ªçc, l·ªõp h·ªçc, gi√°o vi√™n, n·ªôi dung gi·∫£ng d·∫°y'),
('sales_staff', 'Nh√¢n vi√™n t∆∞ v·∫•n kh√°ch h√†ng', 'Ghi danh h·ªçc vi√™n, thanh to√°n, h·ªó tr·ª£ h√†nh ch√≠nh'),
('teacher', 'Gi√°o vi√™n', 'So·∫°n b√†i, gi·∫£ng d·∫°y, ch·∫•m thi, theo d√µi h·ªçc vi√™n'),
('student', 'H·ªçc vi√™n', 'Ng∆∞·ªùi h·ªçc trong h·ªá th·ªëng (mobile app)');

-- ========================================================
-- 3Ô∏è‚É£ PERMISSIONS
-- ========================================================
INSERT INTO permissions (perm_key, module, description)
VALUES
-- USERS & ROLES
('user.manage', 'users', 'Qu·∫£n l√Ω ng∆∞·ªùi d√πng'),
('role.manage', 'roles', 'Qu·∫£n l√Ω vai tr√≤'),
('permission.manage', 'permissions', 'Qu·∫£n l√Ω quy·ªÅn'),


-- COURSES & LESSONS
('course.manage', 'courses', 'Qu·∫£n l√Ω kh√≥a h·ªçc'),
('course.manage.teacher', 'courses', 'Qu·∫£n l√Ω kh√≥a h·ªçc'),

-- LESSONS
('lesson.manage', 'lessons', 'Qu·∫£n l√Ω b√†i h·ªçc & n·ªôi dung (lession_media, t·ª´ v·ª±ng, nghe, ph√°t √¢m, quiz, writing)'),
('lesson.manage.teacher', 'lessons', 'Qu·∫£n l√Ω b√†i h·ªçc & n·ªôi dung (lession_media, t·ª´ v·ª±ng, nghe, ph√°t √¢m, quiz, writing)'),

-- CLASSES
('class.manage', 'classes', 'Qu·∫£n l√Ω / l·∫≠p l·ªãch l·ªõp h·ªçc'),
('class.manage.teacher', 'classes', 'Gi·∫£ng d·∫°y v√† ch·∫•m ƒëi·ªÉm trong l·ªõp'),

-- PROGRESS & ANALYTICS
('progress.view', 'progress', 'Xem ti·∫øn ƒë·ªô to√†n h·ªá th·ªëng'),
('`progress.view.teacher`', 'progress', 'Xem ti·∫øn ƒë·ªô theo kh√≥a / gi√°o vi√™n'),
('progress.view.sales_staff', 'progress', 'Xem ti·∫øn ƒë·ªô theo kh√≥a / gi√°o vi√™n'),

-- REGISTRATIONS
('registration.manage.sales_staff', 'registrations', 'Qu·∫£n l√Ω ƒëƒÉng k√Ω kh√≥a h·ªçc'),

-- PAYMENTS
('payment.manage.sales_staff', 'payments', 'Qu·∫£n l√Ω thanh to√°n v√† th·ªëng k√™'),

-- CERTIFICATES
('certificate.manage', 'certificates', 'Qu·∫£n l√Ω v√† duy·ªát c·∫•p ch·ª©ng ch·ªâ'),

-- REVIEWS
('review.manage', 'reviews', 'Qu·∫£n l√Ω ƒë√°nh gi√° kh√≥a h·ªçc'),

-- NOTIFICATIONS
('notification.manage', 'notifications', 'G·ª≠i th√¥ng b√°o h·ªçc vi√™n / l·ªõp'),
('notification.manage.teacher', 'notifications', 'G·ª≠i th√¥ng b√°o h·ªçc vi√™n c·ªßa kh√≥a h·ªçc'),

-- CHAT
('chat.manage', 'chat', 'Theo d√µi v√† qu·∫£n l√Ω chat'),

-- MINIGAMES
('minigame.manage', 'minigames', 'Qu·∫£n l√Ω minigame v√† leaderboard'),

-- SYSTEM SETTINGS
('system.config', 'system', 'C·∫•u h√¨nh h·ªá th·ªëng'),

-- APP UTILITIES
('utilities.manage', 'utilities', 'Qu·∫£n l√Ω & c·∫•u h√¨nh ti·ªán √≠ch h·ªçc t·∫≠p'),

-- ACTIVITY LOGS
('activity.manage', 'activity_logs', 'Theo d√µi nh·∫≠t k√Ω ho·∫°t ƒë·ªông'),

-- POSTS
('posts.manage', 'posts', 'Qu·∫£n l√Ω b√†i vi·∫øt');

-- ========================================================
-- 4Ô∏è‚É£ ROLE-PERMISSION MAPPING
-- ========================================================

-- SYSTEM ADMIN - t·∫•t c·∫£ quy·ªÅn
INSERT INTO role_permissions (role_id, perm_id)
SELECT r.role_id, p.perm_id
FROM roles r, permissions p
WHERE r.role_name = 'system_admin'
AND p.perm_key IN (
    'user.manage', 'role.manage', 'permission.manage', 'course.manage',
    'lesson.manage', 'class.manage', 'progress.view', 'registration.manage.sales_staff', 'payment.manage.sales_staff',
    'certificate.manage', 'review.manage', 'notification.manage', 'chat.manage',
    'minigame.manage', 'system.config', 'utilities.manage', 'activity.manage',
    'posts.manage'
);

-- ACADEMIC MANAGER
INSERT INTO role_permissions (role_id, perm_id)
SELECT r.role_id, p.perm_id
FROM roles r, permissions p
WHERE r.role_name = 'academic_manager'
AND p.perm_key IN (
    'course.manage', 'lesson.manage', 'class.manage','progress.view',
    'certificate.manage', 'review.manage', 'notification.manage',
    'chat.manage', 'system.config', 'activity.manage',
    'posts.manage'
);

-- SALES STAFF
INSERT INTO role_permissions (role_id, perm_id)
SELECT r.role_id, p.perm_id
FROM roles r, permissions p
WHERE r.role_name = 'sales_staff'
AND p.perm_key IN (
    'progress.view.sales_staff', 'registration.manage.sales_staff',
    'payment.manage.sales_staff', 'notification.manage', 'chat.manage'
);

-- TEACHER
INSERT INTO role_permissions (role_id, perm_id)
SELECT r.role_id, p.perm_id
FROM roles r, permissions p
WHERE r.role_name = 'teacher'
AND p.perm_key IN (
    'course.manage.teacher', 'lesson.manage.teacher', 'class.manage.teacher',
    'progress.view.teacher', 'notification.manage.teacher'
);

-- ========================================================
-- 5Ô∏è‚É£ USER-ROLE MAPPING (L·∫•y ID t·ª± ƒë·ªông theo email & role_name)
-- ========================================================
INSERT INTO user_roles (user_id, role_id)
SELECT u.user_id, r.role_id
FROM users u, roles r
WHERE (u.email, r.role_name) IN (
    ('tranminhnghia4600@gmail.com', 'system_admin'),
    ('nghia3008aaa@gmail.com', 'academic_manager'),
    ('tmnghia4600@gmail.com', 'sales_staff'),
    ('nghiapha1234@gmail.com', 'teacher'),
    ('nguyenvana@gmail.com', 'student'),
    ('tranthib@gmail.com', 'student')
);